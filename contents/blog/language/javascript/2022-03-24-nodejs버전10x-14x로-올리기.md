---
title: "React프로젝트 Nodejs 버전(v10.x → v14.x) 올리기"
date: "2022.03.24"
tags:
  - nodejs
  - cra
  - react
  - 노드버전
---


# React프로젝트 Nodejs 버전(v10.x → v14.x) 올리기

## buildit-co-kr-react 프로젝트 현 스펙

```jsx
// package.json

"react-scripts": "^2.1.8",
"typescript": "3.8",
"node-sass": "^4.14.1",
...
```

- 회사 프로젝트는 2022년 3월 21일 nodejs는 10.23.0 버전을 사용하고 있습니다.

node 버전이 낮은 편이어서 최신 javascript 문법을 쓰지 못하는 문제 상황이 있었는데, 이를 해결하기 위해서는 크게 두 가지 방법이 있습니다.

1️⃣ react-rewire로 CRA 설정 중 babel설정을 override하기

2️⃣ node 버전과 dependecy가 있는 라이브러리들의 버전을 같이 올려서 해결하기

1번의 경우 아래 글에서 작성한 것처럼 이미 작업을 진행해보았습니다.

#### :link:[react-rewired 사용해서 eject없이 CRA에babel설정 추가하기](https://likelionsungguk.github.io/22-03-23/react-rewired-%EC%82%AC%EC%9A%A9%ED%95%B4%EC%84%9C-eject%EC%97%86%EC%9D%B4-CRA%EC%97%90babel%EC%84%A4%EC%A0%95-%EC%B6%94%EA%B0%80%ED%95%98%EA%B8%B0)



1번의 경우 CRA “one build dependecy”가 깨질 수 있는 위험성이 있으므로 이참에 2번 방법을 써보기로 했습니다.

## 버전 선택하기

먼저 nodejs 버전을 선택하기 전에는 다음의 내용들을 체크해봤습니다.

✅ 사용하고자 하는 기능을 제공하는가?

✅ 다른 프로젝트들과 버전 차이가 심하지 않는가?

---

### ✅ 사용하고자 하는 기능을 제공하는가?

중점적으로 생각했던 기능을 ***optional chaining*** 이었습니다.

![출처: mdn](/assets/img/0324-0.png)

출처: mdn

14.0.0 버전 이상부터 지원하는 것을 확인할 수 있었습니다.

### ✅ 다른 프로젝트들과 버전 차이가 심하지 않는가?

- 회사내 다른 프로젝트1: `nodejs14.x`
- 회사내 다른 프로젝트2: `nodejs12.x`

종합적으로 고려해봤을 때 최종적으로 nodejs 14버전을 사용하기로 하였습니다.

nvm 으로 nodejs 버전을 10.23.0. 에서 14.15.4로 바꾸고 나서 npm start를 실행하면 에러가 발생합니다.

![node버전에러](/assets/img/0324-1.png)

node버전에러

```bash
Node Sass version X.0.0 is incompatible with ^4.0.0 
```

보면 node-sass 라이브러리와 의존성 충돌이 일어나고 있습니다.

![nodesass의존성충돌](/assets/img/0324-2.png)

node 14버전은 node-sass 최소 4.14 버전 이상을 설치해줘야 정상 동작하는 것으로 보입니다.

살펴보니 기존 node-sass버전이 4.14 버전이었는데 충돌이 났습니다. 4.14+ 는 이상의 개념보다는 "초과" 개념으로 보고 4.14.1버전을 설치해봤습니다.



## 작업 진행

1. node version 변경 (v14.15.4로 했습니다.)
2. node-sass uninstall
3. node-sass@4.14.1로 재설치 (`npm i node-sass@4.14.1`)
4. react-scripts 버전올리기 `package.json` 에서 "react-scripts":"^3.3.0"
5. package-lock.json 지우고 다시 `npm i`
6. es-lint 오류 수정

위 단계를 실행하다보면 3번 이후에 다음과 같은 에러를 만날 수 있습니다.

```bash
Add @babel/plugin-proposal-optional-chaining
```

이때 react-scripts의 버전을 3.3.0 이상으로 끌어올려주면 위 문제를 해결할 수 있습니다.

(react-rewire를 안쓰고 최대한 react-scripts를 사용하기 위해 react-scripts버전을 같이 올려주었습니다.)

이후 6번까지의 과정을 진행하면 node14버전으로 프로젝트를 컴파일 하여 실행할 수 있습니다.



## 배포 문제 발생

위 작업을 진행하고나면 로컬에서는 문제없이 작동시킬 수 있습니다. 하지만 배포를 하면 빌드가 실패하며 배포에 실패합니다.

![여기까지는 문제없고](/assets/img/0324-3.png)

여기까지는 문제없고

![CI=True](/assets/img/0324-4.png)

여기서부터 [process.env.CI](http://process.env.CI) = true 여서 warnings 를 errors로 본다고 하면서 compile에 실패하는 모습을 보여줍니다.

![컴파일에 실패하고서 gitlab ci의 Job이 실패했습니다.](/assets/img/0324-5.png)

컴파일에 실패하고서 gitlab ci의 Job이 실패했습니다.

### 배포실패 문제원인 찾기

### **What is this error all about? (about netlify deploy)**

Beginning on *June 15, 2020,* Netlify started a gradual rollout of adding the environment variable CI to build environments, with the value of true. This environment variable, short for Continuous Integration, is commonly set in various CI environments like Travis CI and Github Actions, among many others. The ecosystem has largely agreed to use this environment setting to detect when a build is executing in a CI environment, as opposed to a local development environment.

This setting allows many common libraries to detect a CI environment and change behavior accordingly. One such behavior is the disabling of progress “spinners” that while useful in a local development terminal, can render poorly when operating in a log streamed CI environment.

***Because of this some libraries now interpret what were previously just warnings as hard errors and halt the build***. The intention is that developers should not ship potentially broken configurations, but the downside is that builds that successfully completed previously started failing after this change.

위 내용을 요약하면, CI환경은 github actions나 travis 등을 포함하여 다양한 곳에서 일반적으로 설정되고 있습니다. 로컬 개발 환경이 아닌 CI환경에서 빌드가 실행되는 환경에 맞춰서 빌드를 합니다. 왜냐하면 로컬 환경에서는 유용했던 것들이 CI의 log stream과 같은 곳에서 작동할 때는 working poorly 하기 때문입니다.

따라서 `CI=true` 는 기본 설정이며 이 설정이 `true`로 세팅 되어있을 때에는  CI환경에 맞게 warnings를 error로 처리하여 빌드를 정상적으로 구성할 수 있도록 합니다.

장점은 개발자가 config를 파괴하지 못하도록 하는 것이 있습니다. 하지만 단점은 기존에 잘 배포되던 시스템이 이 설정때문에 failed된다는 것입니다.

Facebook 에서도 react-scripts를 통해 빌드할 때 CI=true를 기본설정으로 하기로 했다고 합니다. 여기서는 자기들끼리 엄청나게 discussion을 한 후 내린 결론이라고 하네요.

[https://github.com/facebook/create-react-app/issues/3657](https://github.com/facebook/create-react-app/issues/3657)



### 해결법 (FIX)

```bash
$ CI='' npm run build
       or
$ CI=false npm run build
```

CI=false와 CI= 은 조금 다릅니다.

**“False” isn’t always false**

Though it seems like the logical opposite of `CI=true`, setting `CI=false` may not work as expected. This is because environment variable values are processed as strings, and many libraries interpret *any* non-empty string value for `CI` as `true`.

환경 변수들의 값은 스트링으로 처리되기 때문에 많은 라이브러리에서 non-empty string을 true로 하기 때문입니다. (CI=false로 False값을 주었다고 생각하지만 empty가 아니기 때문에 True라고 오류를 발생시킬 수 있다는 내용입니다.)

회사에서는 gitlab CI를 쓰고 있습니다. gitlab CI에서는 `CI=fase` 로 했을 때 문제 없이 배포를 통과하긴 했습니다.



---

References.

[Optional chaining - JavaScript | MDN](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Operators/Optional_chaining)

[How to enable optional chaining with Create React App and TypeScript](https://stackoverflow.com/questions/59093630/how-to-enable-optional-chaining-with-create-react-app-and-typescript)

[Treating Warnings As Errors Because Process.env.CI = True.](https://360techexplorer.com/treating-warnings-as-errors-because-process-env-ci-true-vercel-netlify-jenkins-etc/)

[[Solved] "Treating warnings as errors because of process.env.CI = true"](https://dev.to/kapi1/solved-treating-warnings-as-errors-because-of-process-env-ci-true-bk5)

